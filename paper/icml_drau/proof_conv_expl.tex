%! TEX root = icml_drau.tex
% Let $\deltat_1 > 0$. 

\begin{align}
  s_{t + \deltat} &= s_t + \sum_{k=1}^{\lfloor 1/\deltat\rfloor} s_{t+k\deltat^2} -  s_{t+(k-1)\deltat^2} + \bigO(\deltat^2) \\
                    &= s_t + \sum_{k=1}^{\lfloor 1/\deltat \rfloor} F(s_{t+(k-1)\deltat^2}, a_k)\deltat^2 + \bigO(\deltat^2)
                    % &= s_t + \sum_{k=1}^{\lfloor \deltat_1/\deltat\rfloor} \left(F(s_{t}, a_k) + \bigO(k\deltat)\right)\deltat + \bigO(\deltat) \\
                    % &= s_t + \sum_{k=1}^{\lfloor \deltat_1/\deltat\rfloor} F(s_{t}, a_k) \deltat + \bigO(\deltat_1^2) + \bigO(\deltat) 
\end{align}

If we define $f(s) = \E_{a \sim \pi(s)}\left[F(s, a)\right]$, then $f$ is \TODO{smooth enough}. We have: 

  \begin{align}
    s_{t + \deltat}   & = s_t + \sum_{k=1}^{\lfloor 1/\deltat\rfloor} f(s_{t+(k-1)\deltat})\deltat^2 + \sum_{k=1}^{\lfloor 1/\deltat\rfloor} (F(s_{t+(k-1)\deltat^2}, a_k) - f(s_{t+(k-1)\deltat^2}))\deltat^2 + \bigO(\deltat^2)        \\
  \end{align}

  We define $\xi = \sum_{k=1}^{\lfloor 1/\deltat\rfloor} (F(s_{t+(k-1)\deltat^2}, a_k) - f(s_{t+(k-1)\deltat^2}))\deltat^2$. We have:
  \begin{align}
    \E[\xi] &= 0 \\
    \E[\|\xi\|^2] &= \bigO(\deltat^3)
  \end{align}

  Therefore:
  \begin{align}
  s_{t + \deltat}  &= s_t + \sum_{k=1}^{\lfloor 1/\deltat\rfloor} \left(f(s_{t}) + \bigO(k\deltat^2)\right)\deltat^2 + \xi + \bigO(\deltat^2) \\
                      & = s_t + f(s_{t}) \deltat + \xi + \bigO(\deltat^2) 
  \end{align}

  Therefore, we have $a>0$ such that $\|s_{t + \deltat} - s_t - f(s_t)\deltat\| \leq \|\xi\| + a\deltat^2$
  
We define $\tilde s_\deltat^{k+1} = f(s_\deltat^k)\deltat$. We have:

\begin{align}
  \|s_{t+(k+1)\deltat} - \tilde{s}_\deltat^{k+1}\| &\leq
                                                     \|s_{t+(k+1)\deltat} - s_t - f(s_t)\deltat\| + \|s_t + f(s_t)\deltat - \tilde{s}_\deltat^{k+1}\|\\
  &\leq \|\xi_k\| + a\deltat^2 + (1+L_f\deltat)\|s_{t+k\deltat} - \tilde{s}_\deltat^{k}\|
\end{align}
where $L_f$ is the Lipschitz constant of $f$ \TODO{justify}.
%We define $w_k = \|s_{t+k\deltat} - \tilde{s}_\deltat^{k}\|$. We have:
By recurrence, we have:
\begin{align}
  w_{k+1} \leq \|\xi_k\| + a\deltat^2 + (1+L_f\deltat)\|s_{t+k\deltat} - \tilde{s}_\deltat^{k}\|w_k
\end{align}
By recurrence:
\begin{align}
  \|s_{t} - \tilde{s}_\deltat^{\lfloor t/\deltat \rfloor} \| \leq \frac{a\deltat}{L_f}\exp(L_ft) + \sum_{j=0}^{\lfloor t/\deltat \rfloor}(1+\deltat L_f)^j\|\xi_j\|  
\end{align}

Therefore, if $\varepsilon >0$, we have:
\begin{align}
  \BP\left(\|s_{t} - \tilde{s}_\deltat^{\lfloor t/\deltat \rfloor} \| > \varepsilon \right) &\leq \BP\left(\sum_{j=0}^{\lfloor t/\deltat \rfloor}(1+\deltat L_f)^j\|\xi_j\| > \varepsilon - \frac{a\deltat}{L_f}\exp(L_ft)\right) \\
                                                                                            &\leq \frac{\E\left[\sum_{j=0}^{\lfloor t/\deltat \rfloor}(1+\deltat L_f)^j\|\xi_j\|\right]}{\varepsilon - \frac{a\deltat}{L_f}\exp(L_ft)}\\
                                                                                            &\leq \frac{\E\left[\|\xi\|\right]}{\varepsilon - \frac{a\deltat}{L_f}\exp(L_ft)}\frac{\exp(L_ft)}{L_f\deltat}\\
  % &\leq \frac{\sqrt{\E\left[\|\xi\|^2\right]}}{\varepsilon - \frac{a\deltat}{L_f}\exp(L_ft)}\frac{\exp(L_f\deltat)}{L_f\deltat}\\
\end{align}
But $\E\left[\|\xi\|\right] \leq \sqrt{\E\left[\|\xi\|^2\right]} \leq \sigma \deltat^{3/2}$. Therefore, we have:
\begin{align}
  \BP\left(\|s_{t} - \tilde{s}_\deltat^{\lfloor t/\deltat \rfloor} \| > \varepsilon \right) & = \bigO(\sqrt \deltat)
\end{align}

Therefore, the random process $s_t$ converge in probability to $\tilde s$. Furthermore, by a similar argument than in Theorem \TODO{the first one}, we know that the discretized process $\tilde s$ converge to the continuous process defined by $\frac{ds}{dt} = f(s_t)$. We can conclude ou result.

% We define for all $0 \leq j \leq \lfloor t/\deltat \rfloor$: $\alpha_j = \omega (1+\deltat L_f)^j$, such that $\sum_j \alpha_j = 1$. Then, we have:
% \begin{align}
%   \BP\left( \sum_{j=0}^{\lfloor t/\deltat \rfloor}(1+\deltat L_f)^j\|\xi_j\| > \varepsilon'\right) & \leq \BP\left( \exists j,  (1+\deltat L_f)^j\|\xi_j\| > \alpha_j\varepsilon'\right) \\
%                                                                                                    & \leq \sum_j \BP\left(  (1+\deltat L_f)^j\|\xi_j\| > \alpha_j\varepsilon'\right)     \\
%                                                                                                    & \leq \sum_j \BP\left(\|\xi_j\| > \omega \varepsilon'\right) \\
%   &\leq \frac{t\sigma^2\deltat^2}{\omega^2 \varepsilon'^2}
% \end{align}
% Moreover, we have $\omega \leq \frac{\exp(L_f t)}{L_f \deltat}$. We have:
% \begin{align}
%   \BP\left( \sum_{j=0}^{\lfloor t/\deltat \rfloor}(1+\deltat L_f)^j\|\xi_j\| > \varepsilon'\right) &\leq  t\sigma\deltat\frac{\exp(L_f t)}{L_f}
% \end{align}
% Finally:
% \begin{align}
%   \BP\left(\|s_{t} - \tilde{s}_\deltat^{\lfloor t/\deltat \rfloor} \| > \varepsilon \right) \leq \BP\left(\sum_{j=0}^{\lfloor t/\deltat \rfloor}(1+\deltat L_f)^j\|\xi_j\| > \varepsilon - \frac{a\deltat}{L_f}\exp(L_ft)\right)
% \end{align}
%%% Local Variables:
%%% TeX-master: "icml_drau"
%%% End:

